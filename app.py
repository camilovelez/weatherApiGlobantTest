from flask import Flask, Response, request
import os
from flask_caching import Cache
import json

from data_handling.weather_data import WeatherData
from data_handling.data_formatting import validate_formats
from get_external_data.weather_api import WeatherApi

DEBUG = True

if DEBUG:
    os.environ["API_ID"] = "1508a9a4840a5574c822d70ca2132032"
    os.environ["API_URL"] = "http://api.openweathermap.org/data/2.5/"
    os.environ["WEATHER_ENDPOINT"] = "weather"
    os.environ["FORECAST_ENDPOINT"] = "forecast"
    os.environ["CACHE_TYPE"] = "SimpleCache"
    os.environ["CACHE_DEFAULT_TIMEOUT"] = "120"

API_ID = os.environ.get("API_ID")
API_URL =  os.environ.get("API_URL")
WEATHER_ENDPOINT = os.environ.get("WEATHER_ENDPOINT")
FORECAST_ENDPOINT = os.environ.get("FORECAST_ENDPOINT")
CACHE_TYPE = os.environ.get("CACHE_TYPE")
CACHE_DEFAULT_TIMEOUT = int(os.environ.get("CACHE_DEFAULT_TIMEOUT"))

config = {
    "DEBUG": DEBUG,         
    "CACHE_TYPE": CACHE_TYPE,  
    "CACHE_DEFAULT_TIMEOUT": CACHE_DEFAULT_TIMEOUT
}

app = Flask(__name__)

app.config.from_mapping(config)
cache = Cache(app)

@app.route("/weather")   
def weather():
    response_data = dict()
    status_code = 400

    response_data_weather, status_code_weather = ({'coord': {'lon': -75.5636, 'lat': 6.2518}, 'weather': [{'id': 803, 'main': 'Clouds', 'description': 'broken clouds', 'icon': '04d'}], 
        'base': 'stations', 'main': {'temp': 19.26, 'feels_like': 19.67, 'temp_min': 19.26, 'temp_max': 19.26, 'pressure': 1012, 'humidity': 93, 'sea_level': 1012, 'grnd_level': 850}, 
        'visibility': 8410, 'wind': {'speed': 1.29, 'deg': 71, 'gust': 1.7}, 'clouds': {'all': 74}, 'dt': 1621810813, 'sys': {'country': 'CO', 'sunrise': 1621766769, 'sunset': 1621811534}, 
        'timezone': -18000, 'id': 3674962, 'name': 'Medell√≠n', 'cod': 200}), 200

    response_data_forecast, status_code_forecast = ({'cod': '200', 'message': 0, 'cnt': 40, 'list': [{'dt': 1621868400, 'main': {'temp': 21.82, 'feels_like': 22.2, 'temp_min': 21.82, 'temp_max': 25.5, 'pressure': 1015, 'sea_level': 1015, 'grnd_level': 855, 'humidity': 82, 'temp_kf': -3.68}, 'weather': [{'id': 802, 'main': 'Clouds', 'description': 'scattered clouds', 'icon': '03d'}], 'clouds': {'all': 44}, 'wind': {'speed': 0.89, 'deg': 108, 'gust': 4.6}, 'visibility': 10000, 'pop': 0.15, 'sys': {'pod': 'd'}, 'dt_txt': '2021-05-24 15:00:00'}, {'dt': 1621879200, 'main': {'temp': 24.55, 'feels_like': 24.78, 'temp_min': 24.55, 'temp_max': 26.83, 'pressure': 1012, 'sea_level': 1012, 'grnd_level': 852, 'humidity': 66, 'temp_kf': -2.28}, 'weather': [{'id': 500, 'main': 'Rain', 'description': 'light rain', 'icon': '10d'}], 'clouds': {'all': 55}, 'wind': {'speed': 1.14, 'deg': 114, 'gust': 3.71}, 'visibility': 10000, 'pop': 0.65, 'rain': {'3h': 0.64}, 'sys': {'pod': 'd'}, 'dt_txt': '2021-05-24 18:00:00'}, {'dt': 1621890000, 'main': {'temp': 25.38, 'feels_like': 25.59, 'temp_min': 25.38, 'temp_max': 25.38, 'pressure': 1008, 'sea_level': 1008, 'grnd_level': 850, 'humidity': 62, 'temp_kf': 0}, 'weather': [{'id': 500, 'main': 'Rain', 'description': 'light rain', 'icon': '10d'}], 'clouds': {'all': 100}, 'wind': {'speed': 1.34, 'deg': 95, 'gust': 2.48}, 'visibility': 10000, 'pop': 0.83, 'rain': {'3h': 0.34}, 'sys': {'pod': 'd'}, 'dt_txt': '2021-05-24 21:00:00'}, {'dt': 1621900800, 'main': {'temp': 18.36, 'feels_like': 18.76, 'temp_min': 18.36, 'temp_max': 18.36, 'pressure': 1013, 'sea_level': 1013, 'grnd_level': 851, 'humidity': 96, 'temp_kf': 0}, 'weather': [{'id': 501, 'main': 'Rain', 'description': 'moderate rain', 'icon': '10n'}], 'clouds': {'all': 100}, 'wind': {'speed': 1.61, 'deg': 78, 'gust': 2.59}, 'visibility': 10000, 'pop': 0.94, 'rain': {'3h': 3.08}, 'sys': {'pod': 'n'}, 'dt_txt': '2021-05-25 00:00:00'}, {'dt': 1621911600, 'main': {'temp': 17.57, 'feels_like': 17.94, 'temp_min': 17.57, 'temp_max': 17.57, 'pressure': 1016, 'sea_level': 1016, 'grnd_level': 853, 'humidity': 98, 'temp_kf': 0}, 'weather': [{'id': 500, 'main': 'Rain', 'description': 'light rain', 'icon': '10n'}], 'clouds': {'all': 100}, 'wind': {'speed': 1, 'deg': 89, 'gust': 1.32}, 'visibility': 8887, 'pop': 0.97, 'rain': {'3h': 1.3}, 'sys': {'pod': 'n'}, 'dt_txt': '2021-05-25 03:00:00'}, {'dt': 1621922400, 'main': {'temp': 16.53, 'feels_like': 16.8, 'temp_min': 16.53, 'temp_max': 16.53, 'pressure': 1015, 'sea_level': 1015, 'grnd_level': 851, 'humidity': 98, 'temp_kf': 0}, 'weather': [{'id': 804, 'main': 'Clouds', 'description': 'overcast clouds', 'icon': '04n'}], 'clouds': {'all': 100}, 'wind': {'speed': 0.79, 'deg': 94, 'gust': 0.82}, 'visibility': 7663, 'pop': 0.8, 'sys': {'pod': 'n'}, 'dt_txt': '2021-05-25 06:00:00'}, {'dt': 1621933200, 'main': {'temp': 16.17, 'feels_like': 16.38, 'temp_min': 16.17, 'temp_max': 16.17, 'pressure': 1015, 'sea_level': 1015, 'grnd_level': 851, 'humidity': 97, 'temp_kf': 0}, 'weather': [{'id': 804, 'main': 'Clouds', 'description': 'overcast clouds', 'icon': '04n'}], 'clouds': {'all': 100}, 'wind': {'speed': 0.5, 'deg': 119, 'gust': 0.54}, 'visibility': 10000, 'pop': 0.48, 'sys': {'pod': 'n'}, 'dt_txt': '2021-05-25 09:00:00'}, {'dt': 1621944000, 'main': {'temp': 17.56, 'feels_like': 17.85, 'temp_min': 17.56, 'temp_max': 17.56, 'pressure': 1016, 'sea_level': 1016, 'grnd_level': 853, 'humidity': 95, 'temp_kf': 0}, 'weather': [{'id': 804, 'main': 'Clouds', 'description': 'overcast clouds', 'icon': '04d'}], 'clouds': {'all': 100}, 'wind': {'speed': 0.67, 'deg': 112, 'gust': 1.12}, 'visibility': 10000, 'pop': 0.4, 'sys': {'pod': 'd'}, 'dt_txt': '2021-05-25 12:00:00'}, {'dt': 1621954800, 'main': {'temp': 23.33, 'feels_like': 23.55, 'temp_min': 23.33, 'temp_max': 23.33, 'pressure': 1015, 'sea_level': 1015, 'grnd_level': 855, 'humidity': 70, 'temp_kf': 0}, 'weather': [{'id': 500, 'main': 'Rain', 'description': 'light rain', 'icon': '10d'}], 'clouds': {'all': 99}, 'wind': {'speed': 0.71, 'deg': 98, 'gust': 2.3}, 'visibility': 10000, 'pop': 0.72, 'rain': {'3h': 0.28}, 'sys': {'pod': 'd'}, 'dt_txt': '2021-05-25 15:00:00'}, {'dt': 1621965600, 'main': {'temp': 22.93, 'feels_like': 23.39, 'temp_min': 22.93, 'temp_max': 22.93, 'pressure': 1012, 'sea_level': 1012, 'grnd_level': 852, 'humidity': 81, 'temp_kf': 0}, 'weather': [{'id': 500, 'main': 'Rain', 'description': 'light rain', 'icon': '10d'}], 'clouds': {'all': 92}, 'wind': {'speed': 1.55, 'deg': 92, 'gust': 2.38}, 'visibility': 10000, 'pop': 1, 'rain': {'3h': 2.36}, 'sys': {'pod': 'd'}, 'dt_txt': '2021-05-25 18:00:00'}, {'dt': 1621976400, 'main': {'temp': 22.35, 'feels_like': 22.89, 'temp_min': 22.35, 'temp_max': 22.35, 'pressure': 1011, 'sea_level': 1011, 'grnd_level': 851, 'humidity': 86, 'temp_kf': 0}, 'weather': [{'id': 500, 'main': 'Rain', 'description': 'light rain', 'icon': '10d'}], 'clouds': {'all': 76}, 'wind': {'speed': 1.39, 'deg': 80, 'gust': 2.14}, 'visibility': 10000, 'pop': 1, 'rain': {'3h': 2.35}, 'sys': {'pod': 'd'}, 'dt_txt': '2021-05-25 21:00:00'}, {'dt': 1621987200, 'main': {'temp': 18.44, 'feels_like': 18.9, 'temp_min': 18.44, 'temp_max': 18.44, 'pressure': 1015, 'sea_level': 1015, 'grnd_level': 852, 'humidity': 98, 'temp_kf': 0}, 'weather': [{'id': 500, 'main': 'Rain', 'description': 'light rain', 'icon': '10n'}], 'clouds': {'all': 88}, 'wind': {'speed': 1.45, 'deg': 90, 'gust': 2.21}, 'visibility': 6188, 'pop': 1, 'rain': {'3h': 2.28}, 'sys': {'pod': 'n'}, 'dt_txt': '2021-05-26 00:00:00'}, {'dt': 1621998000, 'main': {'temp': 18.24, 'feels_like': 18.65, 'temp_min': 18.24, 'temp_max': 18.24, 'pressure': 1016, 'sea_level': 1016, 'grnd_level': 853, 'humidity': 97, 'temp_kf': 0}, 'weather': [{'id': 500, 'main': 'Rain', 'description': 'light rain', 'icon': '10n'}], 'clouds': {'all': 100}, 'wind': {'speed': 0.98, 'deg': 104, 'gust': 1.38}, 'visibility': 10000, 'pop': 1, 'rain': {'3h': 2.58}, 'sys': {'pod': 'n'}, 'dt_txt': '2021-05-26 03:00:00'}, {'dt': 1622008800, 'main': {'temp': 17.38, 'feels_like': 17.73, 'temp_min': 17.38, 'temp_max': 17.38, 'pressure': 1015, 'sea_level': 1015, 'grnd_level': 852, 'humidity': 98, 'temp_kf': 0}, 'weather': [{'id': 500, 'main': 'Rain', 'description': 'light rain', 'icon': '10n'}], 'clouds': {'all': 100}, 'wind': {'speed': 0.79, 'deg': 71, 'gust': 1.05}, 'visibility': 10000, 'pop': 1, 'rain': {'3h': 0.28}, 'sys': {'pod': 'n'}, 'dt_txt': '2021-05-26 06:00:00'}, {'dt': 1622019600, 'main': {'temp': 17.03, 'feels_like': 17.37, 'temp_min': 17.03, 'temp_max': 17.03, 'pressure': 1016, 'sea_level': 1016, 'grnd_level': 852, 'humidity': 99, 'temp_kf': 0}, 'weather': [{'id': 500, 'main': 'Rain', 'description': 'light rain', 'icon': '10n'}], 'clouds': {'all': 99}, 'wind': {'speed': 0.73, 'deg': 81, 'gust': 0.97}, 'visibility': 10000, 'pop': 0.92, 'rain': {'3h': 0.46}, 'sys': {'pod': 'n'}, 'dt_txt': '2021-05-26 09:00:00'}, {'dt': 1622030400, 'main': {'temp': 17.52, 'feels_like': 17.89, 'temp_min': 17.52, 'temp_max': 17.52, 'pressure': 1017, 'sea_level': 1017, 'grnd_level': 853, 'humidity': 98, 'temp_kf': 0}, 'weather': [{'id': 500, 'main': 'Rain', 'description': 'light rain', 'icon': '10d'}], 'clouds': {'all': 99}, 'wind': {'speed': 0.71, 'deg': 92, 'gust': 1.18}, 'visibility': 10000, 'pop': 0.76, 'rain': {'3h': 0.27}, 'sys': {'pod': 'd'}, 'dt_txt': '2021-05-26 12:00:00'}, {'dt': 1622041200, 'main': {'temp': 24.44, 'feels_like': 24.61, 'temp_min': 24.44, 'temp_max': 24.44, 'pressure': 1015, 'sea_level': 1015, 'grnd_level': 855, 'humidity': 64, 'temp_kf': 0}, 'weather': [{'id': 804, 'main': 'Clouds', 'description': 'overcast clouds', 'icon': '04d'}], 'clouds': {'all': 100}, 'wind': {'speed': 0.49, 'deg': 116, 'gust': 1.75}, 'visibility': 10000, 'pop': 0.16, 'sys': {'pod': 'd'}, 'dt_txt': '2021-05-26 15:00:00'}, {'dt': 1622052000, 'main': {'temp': 24.37, 'feels_like': 24.74, 'temp_min': 24.37, 'temp_max': 24.37, 'pressure': 1012, 'sea_level': 1012, 'grnd_level': 853, 'humidity': 72, 'temp_kf': 0}, 'weather': [{'id': 500, 'main': 'Rain', 'description': 'light rain', 'icon': '10d'}], 'clouds': {'all': 100}, 'wind': {'speed': 0.34, 'deg': 50, 'gust': 1.48}, 'visibility': 10000, 'pop': 0.81, 'rain': {'3h': 1.63}, 'sys': {'pod': 'd'}, 'dt_txt': '2021-05-26 18:00:00'}, {'dt': 1622062800, 'main': {'temp': 21.91, 'feels_like': 22.48, 'temp_min': 21.91, 'temp_max': 21.91, 'pressure': 1011, 'sea_level': 1011, 'grnd_level': 851, 'humidity': 89, 'temp_kf': 0}, 'weather': [{'id': 501, 'main': 'Rain', 'description': 'moderate rain', 'icon': '10d'}], 'clouds': {'all': 97}, 'wind': {'speed': 1.39, 'deg': 77, 'gust': 2.44}, 'visibility': 9085, 'pop': 1, 'rain': {'3h': 3.68}, 'sys': {'pod': 'd'}, 'dt_txt': '2021-05-26 21:00:00'}, {'dt': 1622073600, 'main': {'temp': 18.36, 'feels_like': 18.81, 'temp_min': 18.36, 'temp_max': 18.36, 'pressure': 1015, 'sea_level': 1015, 'grnd_level': 852, 'humidity': 98, 'temp_kf': 0}, 'weather': [{'id': 501, 'main': 'Rain', 'description': 'moderate rain', 'icon': '10n'}], 'clouds': {'all': 88}, 'wind': {'speed': 0.78, 'deg': 68, 'gust': 1.41}, 'visibility': 4603, 'pop': 1, 'rain': {'3h': 4.68}, 'sys': {'pod': 'n'}, 'dt_txt': '2021-05-27 00:00:00'}, {'dt': 1622084400, 'main': {'temp': 18.23, 'feels_like': 18.67, 'temp_min': 18.23, 'temp_max': 18.23, 'pressure': 1017, 'sea_level': 1017, 'grnd_level': 854, 'humidity': 98, 'temp_kf': 0}, 
    'weather': [{'id': 501, 'main': 'Rain', 'description': 'moderate rain', 'icon': '10n'}], 'clouds': {'all': 100}, 'wind': {'speed': 1.17, 'deg': 79, 'gust': 2.33}, 'visibility': 2345, 'pop': 1, 'rain': {'3h': 4.38}, 'sys': {'pod': 'n'}, 'dt_txt': '2021-05-27 03:00:00'}, {'dt': 1622095200, 'main': {'temp': 17.74, 'feels_like': 18.15, 'temp_min': 17.74, 'temp_max': 17.74, 'pressure': 1016, 'sea_level': 1016, 'grnd_level': 853, 'humidity': 99, 'temp_kf': 0}, 'weather': [{'id': 501, 'main': 'Rain', 'description': 'moderate rain', 'icon': '10n'}], 'clouds': {'all': 100}, 'wind': {'speed': 0.17, 'deg': 8, 'gust': 0.88}, 'visibility': 1075, 'pop': 1, 'rain': {'3h': 5.16}, 'sys': {'pod': 'n'}, 'dt_txt': '2021-05-27 06:00:00'}, {'dt': 1622106000, 'main': {'temp': 17.12, 'feels_like': 17.47, 'temp_min': 17.12, 'temp_max': 17.12, 'pressure': 1016, 'sea_level': 1016, 'grnd_level': 853, 'humidity': 99, 'temp_kf': 0}, 'weather': [{'id': 500, 'main': 'Rain', 'description': 'light rain', 'icon': '10n'}], 'clouds': {'all': 100}, 'wind': {'speed': 0.12, 'deg': 51, 'gust': 0.15}, 'visibility': 10000, 'pop': 0.85, 'rain': {'3h': 1.16}, 'sys': {'pod': 'n'}, 'dt_txt': '2021-05-27 09:00:00'}, {'dt': 1622116800, 'main': {'temp': 17.79, 'feels_like': 18.18, 'temp_min': 17.79, 'temp_max': 17.79, 'pressure': 1017, 'sea_level': 1017, 'grnd_level': 854, 'humidity': 98, 'temp_kf': 0}, 'weather': [{'id': 500, 'main': 'Rain', 'description': 'light rain', 'icon': '10d'}], 'clouds': {'all': 100}, 'wind': {'speed': 0.23, 'deg': 153, 'gust': 0.4}, 'visibility': 10000, 'pop': 0.85, 'rain': {'3h': 0.62}, 'sys': {'pod': 'd'}, 'dt_txt': '2021-05-27 12:00:00'}, {'dt': 1622127600, 'main': {'temp': 23.38, 'feels_like': 23.65, 'temp_min': 23.38, 'temp_max': 23.38, 'pressure': 1015, 'sea_level': 1015, 'grnd_level': 855, 'humidity': 72, 'temp_kf': 0}, 'weather': [{'id': 500, 'main': 'Rain', 'description': 'light rain', 'icon': '10d'}], 'clouds': {'all': 88}, 'wind': {'speed': 0.43, 'deg': 147, 'gust': 1.84}, 'visibility': 10000, 'pop': 0.3, 'rain': {'3h': 0.6}, 'sys': {'pod': 'd'}, 'dt_txt': '2021-05-27 15:00:00'}, {'dt': 1622138400, 'main': {'temp': 23.13, 'feels_like': 23.64, 'temp_min': 23.13, 'temp_max': 23.13, 'pressure': 1013, 'sea_level': 1013, 'grnd_level': 853, 'humidity': 82, 'temp_kf': 0}, 'weather': [{'id': 500, 'main': 'Rain', 'description': 'light rain', 'icon': '10d'}], 'clouds': {'all': 90}, 'wind': {'speed': 0.74, 'deg': 68, 'gust': 1.82}, 'visibility': 10000, 'pop': 0.94, 'rain': {'3h': 2.53}, 'sys': {'pod': 'd'}, 'dt_txt': '2021-05-27 18:00:00'}, {'dt': 1622149200, 'main': {'temp': 21.35, 'feels_like': 21.92, 'temp_min': 21.35, 'temp_max': 21.35, 'pressure': 1012, 'sea_level': 1012, 'grnd_level': 851, 'humidity': 91, 'temp_kf': 0}, 'weather': [{'id': 501, 'main': 'Rain', 'description': 'moderate rain', 'icon': '10d'}], 'clouds': {'all': 97}, 'wind': {'speed': 1.5, 'deg': 85, 'gust': 2.2}, 'visibility': 10000, 'pop': 1, 'rain': {'3h': 4.02}, 'sys': {'pod': 'd'}, 'dt_txt': '2021-05-27 21:00:00'}, {'dt': 1622160000, 'main': {'temp': 18.03, 'feels_like': 18.45, 'temp_min': 18.03, 'temp_max': 18.03, 'pressure': 1015, 'sea_level': 1015, 'grnd_level': 852, 'humidity': 98, 'temp_kf': 0}, 'weather': [{'id': 501, 'main': 'Rain', 'description': 'moderate rain', 'icon': '10n'}], 'clouds': {'all': 98}, 'wind': {'speed': 0.86, 'deg': 92, 'gust': 1.24}, 'visibility': 7686, 'pop': 1, 'rain': {'3h': 4.72}, 'sys': {'pod': 'n'}, 'dt_txt': '2021-05-28 00:00:00'}, {'dt': 1622170800, 'main': {'temp': 17.61, 'feels_like': 17.99, 'temp_min': 17.61, 'temp_max': 17.61, 'pressure': 1017, 'sea_level': 1017, 'grnd_level': 854, 'humidity': 98, 'temp_kf': 0}, 'weather': [{'id': 501, 'main': 'Rain', 'description': 'moderate rain', 'icon': '10n'}], 'clouds': {'all': 100}, 'wind': {'speed': 0.53, 'deg': 84, 'gust': 0.58}, 'visibility': 10000, 'pop': 1, 'rain': {'3h': 4.47}, 'sys': {'pod': 'n'}, 'dt_txt': '2021-05-28 03:00:00'}, {'dt': 1622181600, 'main': {'temp': 16.67, 'feels_like': 16.98, 'temp_min': 16.67, 'temp_max': 16.67, 'pressure': 1017, 'sea_level': 1017, 'grnd_level': 853, 'humidity': 99, 'temp_kf': 0}, 'weather': [{'id': 500, 'main': 'Rain', 'description': 'light rain', 'icon': '10n'}], 'clouds': {'all': 100}, 'wind': {'speed': 0.79, 'deg': 81, 'gust': 0.75}, 'visibility': 10000, 'pop': 1, 'rain': {'3h': 1.23}, 'sys': {'pod': 'n'}, 'dt_txt': '2021-05-28 06:00:00'}, {'dt': 1622192400, 'main': {'temp': 16.96, 'feels_like': 17.3, 'temp_min': 16.96, 'temp_max': 16.96, 'pressure': 1016, 'sea_level': 1016, 'grnd_level': 852, 'humidity': 99, 'temp_kf': 0}, 'weather': [{'id': 500, 'main': 'Rain', 'description': 'light rain', 'icon': '10n'}], 'clouds': {'all': 100}, 'wind': {'speed': 0.05, 'deg': 286, 'gust': 0.34}, 'visibility': 10000, 'pop': 0.96, 'rain': {'3h': 0.35}, 'sys': {'pod': 'n'}, 'dt_txt': '2021-05-28 09:00:00'}, {'dt': 1622203200, 'main': {'temp': 17.24, 'feels_like': 17.6, 'temp_min': 17.24, 'temp_max': 17.24, 'pressure': 1017, 'sea_level': 1017, 'grnd_level': 854, 'humidity': 99, 'temp_kf': 0}, 'weather': [{'id': 501, 'main': 'Rain', 'description': 'moderate rain', 'icon': '10d'}], 'clouds': {'all': 100}, 'wind': {'speed': 0.19, 'deg': 84, 'gust': 0.44}, 'visibility': 10000, 'pop': 0.95, 'rain': {'3h': 3.21}, 'sys': {'pod': 'd'}, 'dt_txt': '2021-05-28 12:00:00'}, {'dt': 1622214000, 'main': {'temp': 21.84, 'feels_like': 22.25, 'temp_min': 21.84, 'temp_max': 21.84, 'pressure': 1016, 'sea_level': 1016, 'grnd_level': 855, 'humidity': 83, 'temp_kf': 0}, 'weather': [{'id': 500, 'main': 'Rain', 'description': 'light rain', 'icon': '10d'}], 'clouds': {'all': 98}, 'wind': {'speed': 0.72, 'deg': 305, 'gust': 0.67}, 'visibility': 10000, 'pop': 0.72, 'rain': {'3h': 1.21}, 'sys': {'pod': 'd'}, 'dt_txt': '2021-05-28 15:00:00'}, {'dt': 1622224800, 'main': {'temp': 22.93, 'feels_like': 23.39, 'temp_min': 22.93, 'temp_max': 22.93, 'pressure': 1013, 'sea_level': 1013, 'grnd_level': 853, 'humidity': 81, 'temp_kf': 0}, 'weather': [{'id': 500, 'main': 'Rain', 'description': 'light rain', 'icon': '10d'}], 'clouds': {'all': 98}, 'wind': {'speed': 0.66, 'deg': 272, 'gust': 0.88}, 'visibility': 10000, 'pop': 0.82, 'rain': {'3h': 2.32}, 'sys': {'pod': 'd'}, 'dt_txt': '2021-05-28 18:00:00'}, {'dt': 1622235600, 'main': {'temp': 22.13, 'feels_like': 22.59, 'temp_min': 22.13, 'temp_max': 22.13, 'pressure': 1011, 'sea_level': 1011, 'grnd_level': 851, 'humidity': 84, 'temp_kf': 0}, 'weather': [{'id': 500, 'main': 'Rain', 'description': 'light rain', 'icon': '10d'}], 'clouds': {'all': 100}, 'wind': {'speed': 0.39, 'deg': 32, 'gust': 1.2}, 'visibility': 10000, 'pop': 0.88, 'rain': {'3h': 2.36}, 'sys': {'pod': 'd'}, 'dt_txt': '2021-05-28 21:00:00'}, {'dt': 1622246400, 'main': {'temp': 17.83, 'feels_like': 18.2, 'temp_min': 17.83, 'temp_max': 17.83, 'pressure': 1014, 'sea_level': 1014, 'grnd_level': 851, 'humidity': 97, 'temp_kf': 0}, 'weather': [{'id': 501, 'main': 'Rain', 'description': 'moderate rain', 'icon': '10n'}], 'clouds': {'all': 94}, 'wind': {'speed': 1.03, 'deg': 89, 'gust': 1.01}, 'visibility': 10000, 'pop': 0.88, 'rain': {'3h': 3.54}, 'sys': {'pod': 'n'}, 'dt_txt': '2021-05-29 00:00:00'}, {'dt': 1622257200, 'main': {'temp': 17.7, 'feels_like': 18.08, 'temp_min': 17.7, 'temp_max': 17.7, 'pressure': 1016, 'sea_level': 1016, 'grnd_level': 852, 'humidity': 98, 'temp_kf': 0}, 'weather': [{'id': 501, 'main': 'Rain', 'description': 'moderate rain', 'icon': '10n'}], 'clouds': {'all': 97}, 'wind': {'speed': 1.02, 'deg': 83, 'gust': 1.7}, 'visibility': 3437, 'pop': 0.97, 'rain': {'3h': 3.1}, 'sys': {'pod': 'n'}, 'dt_txt': '2021-05-29 03:00:00'}, {'dt': 1622268000, 'main': {'temp': 17.42, 'feels_like': 17.8, 'temp_min': 17.42, 'temp_max': 17.42, 'pressure': 1015, 'sea_level': 1015, 'grnd_level': 852, 'humidity': 99, 'temp_kf': 0}, 'weather': [{'id': 500, 'main': 'Rain', 'description': 'light rain', 'icon': '10d'}], 'clouds': {'all': 98}, 'wind': {'speed': 0.35, 'deg': 14, 'gust': 0.61}, 'visibility': 2531, 'pop': 1, 'rain': {'3h': 2.85}, 'sys': {'pod': 'd'}, 'dt_txt': '2021-05-29 06:00:00'}, {'dt': 1622278800, 'main': {'temp': 16.64, 'feels_like': 16.94, 'temp_min': 16.64, 'temp_max': 16.64, 'pressure': 1014, 'sea_level': 1014, 'grnd_level': 851, 'humidity': 99, 'temp_kf': 0}, 'weather': [{'id': 500, 'main': 'Rain', 'description': 'light rain', 'icon': '10d'}], 'clouds': {'all': 100}, 'wind': {'speed': 0.23, 'deg': 263, 'gust': 0.52}, 'visibility': 4078, 'pop': 0.88, 'rain': {'3h': 2.88}, 'sys': {'pod': 'd'}, 'dt_txt': '2021-05-29 09:00:00'}, {'dt': 1622289600, 'main': {'temp': 16.82, 'feels_like': 17.12, 'temp_min': 16.82, 'temp_max': 16.82, 'pressure': 1016, 'sea_level': 1016, 'grnd_level': 852, 'humidity': 98, 'temp_kf': 0}, 'weather': [{'id': 501, 'main': 'Rain', 'description': 'moderate rain', 'icon': '10d'}], 'clouds': {'all': 100}, 'wind': {'speed': 0.38, 'deg': 165, 'gust': 0.62}, 'visibility': 10000, 'pop': 0.84, 'rain': {'3h': 4.04}, 'sys': {'pod': 'd'}, 'dt_txt': '2021-05-29 12:00:00'}], 'city': {'id': 3674962, 'name': 'Medell√≠n', 'coord': {'lat': 6.2518, 'lon': -75.5636}, 'country': 'CO', 'population': 1999979, 'timezone': -18000, 'sunrise': 1621853169, 'sunset': 1621897946}}), 200



    city = request.args.get("city")
    country = request.args.get("country")

    if city is not None and city.isalpha() and country is not None and country.isalpha() and len(country) == 2:
        
        country = country.lower()
        cache_key = f"{city},{country}"
        cached_data = cache.get(cache_key)
        if cached_data is None:
            weather_api = WeatherApi(API_URL, API_ID, WEATHER_ENDPOINT, FORECAST_ENDPOINT)
            
            # (response_data_weather, status_code_weather, 
            # response_data_forecast, status_code_forecast) = weather_api.get_data(city, country)

            if status_code_weather == 200 and status_code_forecast == 200:

                if validate_formats(response_data_weather, response_data_forecast):

                    status_code = 200
                    response_data = WeatherData(response_data_weather, response_data_forecast).as_dict()
                    if cache_key in cache.cache._cache:
                        cache.delete(cache_key)
                    cache.add(cache_key, response_data)
                else:
                    status_code = 404
                    response_data["error_message"] = "data dont match expected formats"

            elif status_code_weather == 404:
                status_code = 404
                response_data["error_message"] = response_data_weather["message"]
            
            elif status_code_forecast == 404:
                status_code = 404
                response_data["error_message"] = response_data_forecast["message"]
            

        else:
            response_data = cached_data
            status_code = 200
    else:
        response_data["error_message"] = "city and country must be provided and contain only letters, country must be 2 letters long"
    
    return Response(json.dumps(response_data),
                    status=status_code,
                    mimetype="application/json")

